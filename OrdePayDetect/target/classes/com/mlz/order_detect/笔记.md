



恶意登录不是电商网站的特色
只要是网站都要做安全的保证
根支付有关的环节
最后的支付环节对之的安全性的考量会更多
给订单设定一个失效时间，不能一直占着库存
设置失效时间有更多安全方面的保证
有一个时间限制，用户就会有紧迫感
 
 订单失效时间的控制
 如果没有大数据的话
 我们可以使用redis 
 使用redis的话 设置key的失效时间
 否则的话，起一个进程
 传统的方式存在什么问题呢
 数据量特别大的时候
 
 订单的时效性检测可以使用大数据框架flink

 设实时检测订单失效
 在15分钟之内 来了一组事件
 创建之后有没有支付
 什么方式来实现

根时间序列相关
模式序列定义出来
符合某种序列的事件

更关心的是超时的订单
超时订单 匹配了开头但是没有匹配到开头
可以提取超时事件

超时检测的序列
userid 

create

交易id 

 时间戳



状态编程实现逻辑控制
如果定时器到触发的时候pay没有来的时候这个时候做一个报警
具体的处理过程中会出现乱序的数据
pay来的时候已经支付了
create 不是超时可能出现了数据的丢失

先做一个简短的实现 就输出超时报警的情况
如果有pay来过是正常 没有pay来过超时报警

改进  timeout的结果必须在那输出
successful应该马上输出

正常的放主流 不正常的提取出来 放到侧输出流里面

定义各种各样的复杂的情况 if else 状态编程 各种乱序的状态




## 
订单支付事件 
安全性考虑，真正入账的话，要看微信钱包有没有支付的信息
直播平台充值数据可能存在丢掉的情况
我们需要做一个实时的对账
交易成功
传统的会有一个银行的环节，我们真的没有实时对账的需求吗
及时的检测出来异常的状况 
同时处理两条流
一条流是支付的日志 掉第三方接口拿到交易的id 
另外起一个服务来查询交易

两条流的连接，联合处理 多流转换算子
Connect 
flatMap 转换 得到最后的dataStream
processFunction  调用process方法

查询完成交易列表的任务
统计金额的相关的东西
一个有数据 一个没有数据 输出报警信息

将两条流连接起来共同处理
两条流的事件时间
不能直接说没有就直接报警了
他们之间可能
不是说这条流里面的数据
往前和往后是都有可能的
往后默认等待5s钟的时间
如果等2s的话匹配的到
等5s就找不到了
有点向状态编程的时候 考虑两条流的情况

连接在一起 coprocesFunction 判断输出报警信息
在实际的应用的方式
有没有更简单的连接两条流的方式呢 双流join

官网的介绍
flink的join 主要有两种 windowJoin  和  where xxx equals to xxx 

按照同样的key 开时间窗
滑动 滚动  joinFunction
WindowJoin 滚动窗口join 
当前划分的窗口 头连尾  尾连头 
按照相同的
橙色的join绿色的
代码实现
相同的key